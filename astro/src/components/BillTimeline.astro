---
/**
 * BillTimeline — editorial-style legislative progress indicator.
 * Shows the journey of a bill through Parliament as a horizontal
 * ruled timeline with typeset stage markers.
 */
import { slugify } from "../lib/slugify";

interface TimelineSession {
  sessionDate: string;
  sessionId: string;
}

interface Props {
  firstReadingDate?: string | null;
  firstReadingSessionId?: string | null;
  secondReadingSessions?: TimelineSession[];
  passed?: boolean;
  thirdReadingDate?: string | null;
}

const {
  firstReadingDate,
  firstReadingSessionId,
  secondReadingSessions = [],
  passed = false,
  thirdReadingDate,
} = Astro.props;

// Derive current stage
const hasFirstReading = !!firstReadingDate;
const hasSecondReading = secondReadingSessions.length > 0;
const hasPassed = passed || !!thirdReadingDate;

type Stage = "introduced" | "first" | "second" | "passed";

const currentStage: Stage = hasPassed
  ? "passed"
  : hasSecondReading
    ? "second"
    : hasFirstReading
      ? "first"
      : "introduced";

const stageOrder: Record<Stage, number> = {
  introduced: 0,
  first: 1,
  second: 2,
  passed: 3,
};

const currentIdx = stageOrder[currentStage];

// Pre-compute stage rendering data
const stageItems = [
  { key: "introduced", label: "Introduced", numeral: "I" },
  { key: "first", label: "First Reading", numeral: "1" },
  { key: "second", label: "Second Reading", numeral: "2" },
  { key: "passed", label: "Passed", numeral: "\u2713" },
].map((stage, idx) => ({
  ...stage,
  isCompleted: idx <= currentIdx,
  isCurrent: idx === currentIdx,
  isPending: idx > currentIdx,
  showConnector: idx > 0,
  stepClasses: [
    "timeline-step",
    idx <= currentIdx ? "completed" : "",
    idx === currentIdx ? "current" : "",
    idx > currentIdx ? "pending" : "",
  ]
    .filter(Boolean)
    .join(" "),
  connectorClass: idx <= currentIdx ? "timeline-connector filled" : "timeline-connector",
  nodeClass: [
    "timeline-node",
    idx <= currentIdx ? "active" : "",
    idx === currentIdx ? "current" : "",
  ]
    .filter(Boolean)
    .join(" "),
  labelClass: [
    "timeline-step-label",
    idx <= currentIdx ? "active" : "",
    idx === currentIdx ? "current" : "",
  ]
    .filter(Boolean)
    .join(" "),
}));

const currentLabel = stageItems[currentIdx].label;

const formatLongDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString("en-SG", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<section class="bill-timeline" data-pagefind-ignore>
  <!-- Section header -->
  <div class="timeline-header">
    <span class="timeline-label">Legislative Progress</span>
    <span class="timeline-current-stage">{currentLabel}</span>
  </div>

  <!-- Horizontal step indicator -->
  <div class="timeline-track">
    {
      stageItems.map((stage) => (
        <div class={stage.stepClasses}>
          {stage.showConnector && <div class={stage.connectorClass} />}
          <div class={stage.nodeClass}>
            <span class="timeline-numeral">{stage.numeral}</span>
          </div>
          <span class={stage.labelClass}>{stage.label}</span>
        </div>
      ))
    }
  </div>

  <!-- Date details -->
  <div class="timeline-details">
    {
      hasFirstReading && firstReadingDate && firstReadingSessionId && (
        <div class="timeline-detail-row">
          <span class="detail-stage">1st Reading</span>
          <span class="detail-rule" />
          <a
            href={`/sessions/${slugify(firstReadingDate, firstReadingSessionId)}`}
            class="detail-date"
          >
            {formatLongDate(firstReadingDate)}
          </a>
        </div>
      )
    }
    {
      secondReadingSessions.map((session, idx) => (
        <div class="timeline-detail-row">
          <span class="detail-stage">
            2nd Reading
            {secondReadingSessions.length > 1 ? ` (${idx + 1})` : ""}
          </span>
          <span class="detail-rule" />
          <a
            href={`/sessions/${slugify(session.sessionDate, session.sessionId)}`}
            class="detail-date"
          >
            {formatLongDate(session.sessionDate)}
          </a>
        </div>
      ))
    }
    {
      thirdReadingDate && (
        <div class="timeline-detail-row">
          <span class="detail-stage">3rd Reading</span>
          <span class="detail-rule" />
          <span class="detail-date detail-date-passed">
            {formatLongDate(thirdReadingDate)}
          </span>
        </div>
      )
    }
  </div>
</section>

<style>
  .bill-timeline {
    border: 1px solid var(--border);
    background: var(--surface);
    padding: 1.75rem 2rem 1.5rem;
  }

  /* ── Header ── */
  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 1.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .timeline-label {
    font-family: "DM Sans", system-ui, sans-serif;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .timeline-current-stage {
    font-family: "Source Serif 4", Georgia, serif;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--accent);
  }

  /* ── Track ── */
  .timeline-track {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    position: relative;
    margin-bottom: 1.75rem;
  }

  .timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
    gap: 0.6rem;
  }

  .timeline-step:first-child {
    align-items: flex-start;
  }

  .timeline-step:last-child {
    align-items: flex-end;
  }

  /* ── Connector ── */
  .timeline-connector {
    position: absolute;
    top: 12px;
    right: calc(50% + 14px);
    left: calc(-50% + 14px);
    height: 1px;
    background: var(--border);
  }

  .timeline-step:last-child .timeline-connector {
    right: calc(0% + 14px);
  }

  .timeline-step:nth-child(2) .timeline-connector {
    left: 0;
  }

  .timeline-connector.filled {
    height: 2px;
    background: var(--ink);
  }

  /* ── Node ── */
  .timeline-node {
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .timeline-node.active {
    background: var(--ink);
    border-color: var(--ink);
  }

  .timeline-node.current {
    box-shadow: 0 0 0 3px var(--surface), 0 0 0 4px var(--ink);
  }

  .timeline-numeral {
    font-family: "Playfair Display", Georgia, serif;
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--ink-muted);
    line-height: 1;
  }

  .timeline-node.active .timeline-numeral {
    color: var(--surface);
  }

  /* ── Step label ── */
  .timeline-step-label {
    font-family: "Source Serif 4", Georgia, serif;
    font-size: 0.7rem;
    font-weight: 300;
    color: var(--ink-muted);
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  .timeline-step-label.active {
    color: var(--ink-soft);
    font-weight: 400;
  }

  .timeline-step-label.current {
    color: var(--ink);
    font-weight: 600;
  }

  /* ── Details ── */
  .timeline-details {
    border-top: 1px solid var(--border);
    padding-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .timeline-detail-row {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
  }

  .detail-stage {
    font-family: "DM Sans", system-ui, sans-serif;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--ink-muted);
    flex-shrink: 0;
    min-width: 7rem;
  }

  .detail-rule {
    flex: 1;
    height: 1px;
    background: linear-gradient(
      to right,
      var(--border) 0%,
      var(--border) 40%,
      transparent 40%,
      transparent 60%,
      var(--border) 60%
    );
    background-size: 8px 1px;
    min-width: 1rem;
  }

  .detail-date {
    font-family: "Source Serif 4", Georgia, serif;
    font-size: 0.8rem;
    font-weight: 400;
    color: var(--ink-soft);
    text-decoration: none;
    flex-shrink: 0;
    transition: color 0.2s ease;
  }

  .detail-date:hover {
    color: var(--accent);
  }

  .detail-date-passed {
    color: var(--accent);
    font-weight: 600;
  }

  /* ── Responsive ── */
  @media (max-width: 480px) {
    .bill-timeline {
      padding: 1.25rem 1.25rem 1rem;
    }

    .timeline-step-label {
      font-size: 0.6rem;
    }

    .timeline-node {
      width: 22px;
      height: 22px;
    }

    .timeline-numeral {
      font-size: 0.6rem;
    }

    .timeline-connector {
      top: 10px;
      right: calc(50% + 12px);
      left: calc(-50% + 12px);
    }

    .timeline-step:last-child .timeline-connector {
      right: calc(0% + 12px);
    }

    .timeline-step:nth-child(2) .timeline-connector {
      left: 0;
    }

    .detail-stage {
      min-width: auto;
    }

    .timeline-detail-row {
      gap: 0.5rem;
    }

    .detail-date {
      font-size: 0.72rem;
    }
  }
</style>
