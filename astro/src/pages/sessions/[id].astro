---
import Layout from '../../layouts/Layout.astro';
import SectionCard from '../../components/SectionCard.astro';
import { getSessions, getSession, getSessionSections, getSessionAttendees, getSessionBills } from '../../lib/db';

export async function getStaticPaths() {
  const sessions = getSessions();
  return sessions.map((session) => ({
    params: { id: session.id },
  }));
}

const { id } = Astro.params;
const session = getSession(id);

if (!session) {
  return Astro.redirect('/sessions');
}

const sections = getSessionSections(id);
const attendees = getSessionAttendees(id);
const bills = getSessionBills(id);

// Helper to format ordinal numbers (1st, 2nd, 3rd, etc.)
function getOrdinal(n: number): string {
  const s = ['th', 'st', 'nd', 'rd'];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

const formattedDate = new Date(session.date).toLocaleDateString('en-SG', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Filter sections by type
const questions = sections.filter(s => ['OA', 'WA', 'WANA'].includes(s.sectionType));
const statements = sections.filter(s => ['OS', 'WS'].includes(s.sectionType) || s.category === 'motion' || s.category === 'clarification');

const motions = statements.filter(s => s.category !== 'clarification');
const clarifications = statements.filter(s => s.category === 'clarification');

const oralAnswers = questions.filter(q => q.sectionType === 'OA');
const writtenAnswers = questions.filter(q => ['WA', 'WANA'].includes(q.sectionType));

const presentMembers = attendees.filter(a => a.present);
const absentMembers = attendees.filter(a => !a.present);
---

<Layout title={formattedDate} description={`Parliament sitting on ${formattedDate}`}>
  <a href="/sessions" class="mb-6 inline-flex items-center text-sm text-blue-600 hover:underline">
    &larr; Back to Sittings
  </a>

  <header class="mb-8">
    <h1 class="mb-2 text-3xl font-bold text-zinc-900">
      {formattedDate}
    </h1>
    <div class="flex flex-wrap gap-3 text-sm text-zinc-600">
      <span>{getOrdinal(session.parliament)} Parliament</span>
      <span>&bull;</span>
      <span>{getOrdinal(session.sessionNo)} Session</span>
      <span>&bull;</span>
      <span>{getOrdinal(session.sittingNo)} Sitting</span>
      {session.url && (
        <>
          <span>&bull;</span>
          <a
            href={session.url}
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            Full report from Hansard &nearr;
          </a>
        </>
      )}
    </div>
  </header>

  <!-- Attendance -->
  {attendees.length > 0 && (
    <section class="mb-8">
      <details class="group">
        <summary class="mb-4 flex cursor-pointer items-center gap-2 text-xl font-semibold text-zinc-900 list-none">
          <span>Members ({presentMembers.length} present, {absentMembers.length} absent)</span>
          <svg
            class="h-5 w-5 transition-transform group-open:rotate-180"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </summary>

        <div class="rounded-lg border border-zinc-200 bg-white p-5">
          <!-- Present -->
          <div class="mb-4">
            <h3 class="mb-2 text-sm font-semibold uppercase text-green-600">
              Present ({presentMembers.length})
            </h3>
            <div class="flex flex-wrap gap-2">
              {presentMembers.map((member) => (
                <a
                  href={`/members/${member.id}`}
                  class="rounded-full bg-green-50 px-3 py-1 text-sm text-green-700 transition-colors hover:bg-green-100"
                >
                  {member.name}
                  {member.designation && (
                    <span class="ml-1 text-green-500">
                      ({member.designation})
                    </span>
                  )}
                </a>
              ))}
            </div>
          </div>

          <!-- Absent -->
          {absentMembers.length > 0 && (
            <div>
              <h3 class="mb-2 text-sm font-semibold uppercase text-zinc-500">
                Absent ({absentMembers.length})
              </h3>
              <div class="flex flex-wrap gap-2">
                {absentMembers.map((member) => (
                  <a
                    href={`/members/${member.id}`}
                    class="rounded-full bg-zinc-100 px-3 py-1 text-sm text-zinc-500 transition-colors hover:bg-zinc-200"
                  >
                    {member.name}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </details>
    </section>
  )}

  <!-- Motions -->
  {motions.length > 0 && (
    <section class="mb-8">
      <h2 class="mb-4 text-xl font-semibold text-zinc-900">
        Motions ({motions.length})
      </h2>
      <div class="grid gap-4">
        {motions.map((section) => (
          <SectionCard section={section} />
        ))}
      </div>
    </section>
  )}

  <!-- Bills -->
  {bills.length > 0 && (
    <section class="mb-8">
      <h2 class="mb-4 text-xl font-semibold text-zinc-900">
        Bills ({bills.length})
      </h2>
      <div class="grid gap-4">
        {bills.map((bill) => (
          <a href={`/bills/${bill.billId}`} class="block">
            <div class="group rounded-lg border border-zinc-200 bg-white p-4 transition-all hover:border-purple-300 hover:shadow-md">
              <div class="mb-2 flex flex-wrap items-center gap-2">
                {bill.readingTypes.includes('BI') && (
                  <span class="rounded bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700">
                    1st Reading
                  </span>
                )}
                {bill.readingTypes.includes('BP') && (
                  <span class="rounded bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700">
                    2nd Reading
                  </span>
                )}
                {bill.ministry && (
                  <span class="rounded bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                    {bill.ministry}
                  </span>
                )}
              </div>
              <h3 class="line-clamp-2 font-semibold text-zinc-900 group-hover:text-purple-600">
                {bill.sectionTitle}
              </h3>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- Oral Answers -->
  <section class="mb-8">
    <h2 class="mb-4 text-xl font-semibold text-zinc-900">
      Oral Answers ({oralAnswers.length})
    </h2>
    {oralAnswers.length === 0 ? (
      <p class="py-4 text-zinc-500">No oral answers in this session</p>
    ) : (
      <div class="grid gap-4">
        {oralAnswers.map((section) => (
          <SectionCard section={section} />
        ))}
      </div>
    )}
  </section>

  <!-- Written Answers -->
  <section class="mb-8">
    <h2 class="mb-4 text-xl font-semibold text-zinc-900">
      Written Answers ({writtenAnswers.length})
    </h2>
    {writtenAnswers.length === 0 ? (
      <p class="py-4 text-zinc-500">No written answers in this session</p>
    ) : (
      <div class="grid gap-4">
        {writtenAnswers.map((section) => (
          <SectionCard section={section} />
        ))}
      </div>
    )}
  </section>

  <!-- Clarifications -->
  {clarifications.length > 0 && (
    <section class="mb-8">
      <h2 class="mb-4 text-xl font-semibold text-zinc-900">
        Clarifications ({clarifications.length})
      </h2>
      <div class="grid gap-4">
        {clarifications.map((section) => (
          <SectionCard section={section} />
        ))}
      </div>
    </section>
  )}
</Layout>
