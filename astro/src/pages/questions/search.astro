---
import Layout from "../../layouts/Layout.astro";
import SectionLabel from "../../components/SectionLabel.astro";
---

<Layout
  title="Search Questions"
  description="Search Singapore Parliament questions and answers"
>
  <SectionLabel>Question Time</SectionLabel>

  <h1 class="font-display text-display-lg text-ink mb-4">Search Questions</h1>

  <p
    class="font-body text-base text-ink-soft leading-relaxed max-w-[58ch] mb-8"
  >
    Search across all parliamentary questions by title, speaker, or content.
  </p>

  <div class="mb-6">
    <div class="relative">
      <svg
        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 pointer-events-none"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        type="text"
        id="search-input"
        class="w-full rounded-lg border border-border bg-surface px-4 py-2.5 pl-10 pr-10 font-ui text-sm text-ink placeholder:text-ink/40 focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent/20 transition-colors"
        placeholder="Search questions by title, speaker, or content..."
        autocomplete="off"
        spellcheck="false"
      />
      <button
        type="button"
        id="clear-btn"
        class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 hover:text-ink transition-colors hidden"
        aria-label="Clear search"
      >
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>

  <p id="search-status" class="font-sans text-sm text-ink-muted mb-6 hidden">
  </p>

  <div id="search-results" class="flex flex-col border-t border-border">
    <p id="empty-state" class="py-12 text-center font-body text-ink-muted">
      Enter a search term to find questions
    </p>
  </div>

  <div class="mt-6">
    <a
      href="/questions"
      class="inline-flex items-center gap-1.5 font-ui text-sm text-ink/70 hover:text-accent transition-colors mt-4"
    >
      <svg
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to all questions
    </a>
  </div>
</Layout>

<script>
  interface PagefindResultData {
    meta?: {
      id?: string;
      title?: string;
      type?: string;
    };
    url: string;
    excerpt: string;
  }

  interface PagefindResult {
    id: string;
    data: () => Promise<PagefindResultData>;
  }

  interface PagefindSearch {
    results: PagefindResult[];
  }

  interface Pagefind {
    search: (
      query: string,
      options?: { filters?: Record<string, string> },
    ) => Promise<PagefindSearch>;
  }

  let pagefind: Pagefind | null = null;

  async function loadPagefind(): Promise<Pagefind | null> {
    if (pagefind) return pagefind;
    try {
      const base = import.meta.env.BASE_URL || "/";
      const pagefindPath = `${base}pagefind/pagefind.js`.replace(/\/+/g, "/");
      pagefind = (await import(/* @vite-ignore */ pagefindPath)) as Pagefind;
      return pagefind;
    } catch (e) {
      console.warn(
        "Pagefind not available. Run `bun run build` to generate the search index.",
      );
      return null;
    }
  }

  function createResultCard(data: PagefindResultData): HTMLElement {
    const card = document.createElement("a");
    card.href = data.url;
    card.className =
      "group block p-5 border-b border-border transition-colors hover:bg-warm cursor-pointer";

    const title = data.meta?.title || "Untitled";
    const excerpt = data.excerpt || "";

    card.innerHTML = `
      <h3 class="font-display text-lg text-ink leading-snug mb-2 group-hover:text-accent transition-colors line-clamp-2">
        ${escapeHtml(title)}
      </h3>
      <p class="font-body text-sm text-ink-soft leading-relaxed line-clamp-2">
        ${excerpt}
      </p>
    `;

    return card;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function initSearch() {
    const input = document.getElementById("search-input") as HTMLInputElement;
    const clearBtn = document.getElementById("clear-btn") as HTMLButtonElement;
    const status = document.getElementById("search-status") as HTMLElement;
    const results = document.getElementById("search-results") as HTMLElement;
    const emptyState = document.getElementById("empty-state") as HTMLElement;

    if (!input || !results) return;

    // Check if already initialized
    if (input.hasAttribute("data-search-initialized")) return;
    input.setAttribute("data-search-initialized", "true");

    let debounceTimer: ReturnType<typeof setTimeout>;

    async function performSearch(query: string) {
      if (!query.trim()) {
        results.innerHTML = "";
        results.appendChild(emptyState);
        emptyState.textContent = "Enter a search term to find questions";
        emptyState.classList.remove("hidden");
        status.classList.add("hidden");
        clearBtn.classList.add("hidden");
        return;
      }

      clearBtn.classList.remove("hidden");

      const pf = await loadPagefind();
      if (!pf) {
        results.innerHTML = "";
        results.appendChild(emptyState);
        emptyState.textContent =
          "Search is not available. Please run 'bun run build' first.";
        emptyState.classList.remove("hidden");
        status.classList.add("hidden");
        return;
      }

      // Show loading state
      results.innerHTML = "";
      results.appendChild(emptyState);
      emptyState.textContent = "Searching...";
      emptyState.classList.remove("hidden");

      const searchResults = await pf.search(query, {
        filters: { type: "question" },
      });

      results.innerHTML = "";

      if (searchResults.results.length === 0) {
        results.appendChild(emptyState);
        emptyState.textContent = `No questions found for "${query}"`;
        emptyState.classList.remove("hidden");
        status.classList.add("hidden");
        return;
      }

      // Load and render results
      const fragment = document.createDocumentFragment();
      for (const result of searchResults.results) {
        const data = await result.data();
        const card = createResultCard(data);
        fragment.appendChild(card);
      }

      results.appendChild(fragment);
      status.textContent = `Found ${searchResults.results.length} result${searchResults.results.length !== 1 ? "s" : ""}`;
      status.classList.remove("hidden");
    }

    input.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        performSearch(input.value);
        // Update URL without reload
        const url = new URL(window.location.href);
        if (input.value) {
          url.searchParams.set("q", input.value);
        } else {
          url.searchParams.delete("q");
        }
        window.history.replaceState({}, "", url.toString());
      }, 200);
    });

    clearBtn.addEventListener("click", () => {
      input.value = "";
      performSearch("");
      input.focus();
      // Clear URL param
      const url = new URL(window.location.href);
      url.searchParams.delete("q");
      window.history.replaceState({}, "", url.toString());
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && input.value) {
        input.value = "";
        performSearch("");
        const url = new URL(window.location.href);
        url.searchParams.delete("q");
        window.history.replaceState({}, "", url.toString());
      }
    });

    // Preload pagefind on focus
    input.addEventListener(
      "focus",
      () => {
        loadPagefind();
      },
      { once: true },
    );

    // Check for initial query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get("q");
    if (initialQuery) {
      input.value = initialQuery;
      performSearch(initialQuery);
    }
  }

  // Initialize on page load and after view transitions
  initSearch();
  document.addEventListener("astro:after-swap", initSearch);
</script>
